<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>결과 보기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-bubble {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .chat-bubble.show {
            opacity: 1;
            transform: translateY(0);
        }
        #chat-container::-webkit-scrollbar { width: 8px; }
        #chat-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #chat-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #chat-container::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <div class="text-center mb-6">
            <h1 id="result-title" class="text-2xl md:text-3xl font-bold text-gray-800">결과를 불러오는 중...</h1>
        </div>

        <!-- 채팅 결과 표시 영역 -->
        <div class="bg-gray-50 h-96 rounded-lg p-4 overflow-y-auto border" id="chat-container">
            <!-- 메시지가 여기에 동적으로 추가됩니다 -->
        </div>
        
        <div class="text-center mt-6">
            <a href="/" class="text-blue-600 hover:underline">다시하기</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatContainer = document.getElementById('chat-container');
            const resultTitle = document.getElementById('result-title');

            const params = new URLSearchParams(window.location.search);
            const birthday = params.get('birthday');

            if (!birthday) {
                resultTitle.textContent = '생년월일 정보가 없습니다.';
                return;
            }

            resultTitle.textContent = `${birthday.substring(0,4)}년 ${birthday.substring(4,6)}월 ${birthday.substring(6,8)}일님의 이야기`;

            // --- 캐시 문제를 해결하기 위해 URL에 타임스탬프 추가 ---
            const timestamp = new Date().getTime();
            const apiUrl = `/api/fortune?birthday=${birthday}&t=${timestamp}`;

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || '데이터를 불러오지 못했습니다.') });
                    }
                    return response.json();
                })
                .then(data => {
                    // --- 서버가 보내준 생성 시간을 콘솔에 출력 ---
                    console.log("서버가 데이터를 생성한 시간:", data.generatedAt);
                    displayMessages(data.messages);
                })
                .catch(error => {
                    addMessageBubble(`오류가 발생했습니다: ${error.message}`, true);
                });

            const displayMessages = (messages) => {
                if (!messages || messages.length === 0) {
                    addMessageBubble('표시할 메시지가 없습니다.', true);
                    return;
                }
                let delay = 0;
                messages.forEach(text => {
                    setTimeout(() => {
                        addMessageBubble(text);
                    }, delay);
                    delay += 800;
                });
            };

            const addMessageBubble = (text, isError = false) => {
                const bubble = document.createElement('div');
                const bubbleColor = isError ? 'bg-red-500' : 'bg-blue-500';
                bubble.className = `chat-bubble max-w-xs md:max-w-sm ${bubbleColor} text-white p-3 rounded-lg rounded-bl-none mb-3 shadow`;
                bubble.textContent = text;
                chatContainer.appendChild(bubble);
                
                setTimeout(() => bubble.classList.add('show'), 10);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            };
        });
    </script>
</body>
</html>
